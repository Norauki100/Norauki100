<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nerus OS HTML</title>
    <!-- Tailwind CSS CDNを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Interフォントを全体に適用 */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* フェードインアニメーション用のCSSキーフレーム */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 1s ease-out forwards;
        }

        /* アプリケーションアイコンのホバー効果 (カスタム説明用) */
        /* pタグに直接適用するため、このCSSルールは不要になりましたが、互換性のため残します。 */
        /* .app-icon:hover .icon-text { opacity: 1; transform: translateY(0); } */

        /* 予測変換リストのスタイルを改善 */
        .autocomplete-list {
            position: absolute;
            width: calc(100% - 70px); /* URL入力バーの幅に合わせて調整 */
            max-height: 200px;
            overflow-y: auto;
            background-color: #4B5563; /* gray-600に変更して明るくする */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            z-index: 60; /* ウィンドウより手前 */
            margin-top: 5px; /* 入力フィールドとの間隔 */
            top: calc(100% + 5px); /* 入力フィールドのすぐ下に表示 */
            left: 0;
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: #FFFFFF; /* whiteに変更して見やすくする */
        }

        .autocomplete-item:hover {
            background-color: #6B7280; /* gray-500に変更してホバー時もコントラストを保つ */
        }

        /* 時計のフォントを等幅に */
        #clock {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        /* スタートメニューの高さ調整と位置決め */
        #start-menu {
            top: 15px;    /* アプリウィンドウと合わせて15pxに調整 */
            bottom: 68px; /* アプリウィンドウと合わせて68pxに調整 */
            left: 0;      /* transformの基準点を左端に設定 */
            transform: translateX(-100%); /* 初期状態は自身の幅の100%分左に移動して完全に隠す */
            transition: transform 0.3s ease-out; /* transformプロパティをアニメーションさせる */
            z-index: 60; /* アプリケーションウィンドウより手前に表示 */
        }

        /* スタートメニューが表示される時のクラス */
        #start-menu.start-menu-active {
            transform: translateX(0); /* 左端から0pxの位置に移動（余白なし） */
        }

        /* ファイルエクスプローラーのサイドバー用CSS */
        .sidebar {
            width: 250px; /* 展開時のデフォルト幅 */
            transition: width 0.3s ease-out;
            flex-shrink: 0; /* 縮小しないようにする */
            overflow: hidden; /* 折りたたみ時に内容を隠す */
        }
        .sidebar.collapsed {
            width: 60px; /* 折りたたみ時の幅 */
        }
        .sidebar.collapsed .sidebar-text {
            display: none; /* テキストを隠す */
        }
        .sidebar.collapsed .sidebar-item {
            justify-content: center; /* アイコンを中央揃えに */
            padding-left: 0;
            padding-right: 0;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 8px 12px; /* デフォルトのパディング */
            white-space: nowrap; /* テキストの折り返しを防ぐ */
            overflow: hidden; /* はみ出したテキストを隠す */
            text-overflow: ellipsis; /* はみ出したテキストを...で表示 */
        }
        .sidebar-item svg {
            flex-shrink: 0; /* アイコンが縮小しないようにする */
        }
        .sidebar-item .sidebar-text {
            flex-grow: 1; /* テキストが残りのスペースを占めるように */
            margin-left: 8px; /* アイコンとテキストの間隔 */
        }

        /* カスタムぼかし効果 (50%に調整) */
        .backdrop-blur-50-percent { /* クラス名を変更 */
            backdrop-filter: blur(6px); /* 12px * 0.5 = 6px */ /* ぼかし強度を調整 */
            -webkit-backdrop-filter: blur(6px); /* Safari対応 */
        }

        /* カスタムカラーピッカーのスタイル (ペイントツール用) */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: none;
            border: none;
            width: 100%;
            height: 40px; /* ボタンの高さに合わせる */
            padding: 0;
            cursor: pointer;
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* 色選択部分を丸く見せるため */
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
        }

        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
        }

        /* カスタムスクロールバー (ペイントツールにも適用されるようにグローバルに配置) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #606f8a; /* gray-500 */
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden" style="background-image: linear-gradient(to bottom right, #191970, #483d8b);">

    <!-- デスクトップ領域 -->
    <div class="flex-grow flex p-8">
        <!-- デスクトップのコンテンツをここに追加します -->
        <div class="grid grid-cols-6 gap-6 w-full h-full">
            <!-- アプリケーションアイコンのプレースホルダー -->
            <!-- Nerus Browserアプリ -->
            <div class="flex flex-col items-center justify-start text-white group app-icon"> <!-- title属性を削除 -->
                <div id="nerus-browser-clickable-icon" class="w-16 h-16 bg-blue-600 bg-opacity-70 rounded-2xl flex items-center justify-center shadow-lg hover:scale-110 transition-transform duration-200 cursor-pointer">
                    <!-- シンプルなブラウザアイコンを表現するSVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16L2 12l4-4" />
                    </svg>
                </div>
                <!-- opacity-0とpointer-events-noneを削除し、opacity-80とtransition-opacityを維持 -->
                <p class="text-sm mt-2 text-shadow-sm opacity-80 group-hover:opacity-100 transition-opacity duration-200">Nerus Browser</p>
            </div>

            <!-- omg noteアプリ -->
            <div class="flex flex-col items-center justify-start text-white group app-icon"> <!-- title属性を削除 -->
                <div id="omg-note-clickable-icon" class="w-16 h-16 bg-purple-600 bg-opacity-70 rounded-2xl flex items-center justify-center shadow-lg hover:scale-110 transition-transform duration-200 cursor-pointer">
                    <!-- メモ帳アイコンを表現するSVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </div>
                <!-- opacity-0とpointer-events-noneを削除し、opacity-80とtransition-opacityを維持 -->
                <p class="text-sm mt-2 text-shadow-sm opacity-80 group-hover:opacity-100 transition-opacity duration-200">omg note</p>
            </div>

            <!-- Nerus Calculatorアプリ -->
            <div class="flex flex-col items-center justify-start text-white group app-icon"> <!-- title属性を削除 -->
                <div id="nerus-calculator-clickable-icon" class="w-16 h-16 bg-red-600 bg-opacity-70 rounded-2xl flex items-center justify-center shadow-lg hover:scale-110 transition-transform duration-200 cursor-pointer">
                    <!-- 電卓アイコンを表現するSVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m-3 4v6m-2-2h4m2 0H7m12-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2z" />
                    </svg>
                </div>
                <!-- opacity-0とpointer-events-noneを削除し、opacity-80とtransition-opacityを維持 -->
                <p class="text-sm mt-2 text-shadow-sm opacity-80 group-hover:opacity-100 transition-opacity duration-200">Nerus Calculator</p>
            </div>

            <!-- Nerus Paint Toolアプリ -->
            <div class="flex flex-col items-center justify-start text-white group app-icon"> <!-- title属性を削除 -->
                <div id="nerus-paint-tool-clickable-icon" class="w-16 h-16 bg-pink-600 bg-opacity-70 rounded-2xl flex items-center justify-center shadow-lg hover:scale-110 transition-transform duration-200 cursor-pointer">
                    <!-- ペイントブラシアイコンのSVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343V4.766a2 2 0 012.535-1.921l2.766.766a2 2 0 011.921 2.535V16.5M18 9l-4 4" />
                    </svg>
                </div>
                <!-- opacity-0とpointer-events-noneを削除し、opacity-80とtransition-opacityを維持 -->
                <p class="text-sm mt-2 text-shadow-sm opacity-80 group-hover:opacity-100 transition-opacity duration-200">Nerus Paint</p>
            </div>
        </div>
    </div>

    <!-- タスクバー/ドックコンテナ -->
    <div class="w-full flex justify-center fixed bottom-0 left-0 right-0 z-55"> <!-- z-indexを上げて常に最前面に表示 -->
        <!-- タスクバー本体 -->
        <div class="w-[800px] bg-gray-900 bg-opacity-70 backdrop-blur-50-percent py-1 flex justify-between items-center rounded-2xl shadow-lg px-8 space-x-4" style="margin-bottom: 7px;">
            <!-- 左側のスタートメニューとアプリアイコン -->
            <div class="flex items-center space-x-4">
                <!-- スタートメニューアイコン (塗りつぶされた円のSVG) -->
                <div id="start-button" class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white text-xl shadow-md hover:scale-105 transition-transform duration-200 cursor-pointer" title="スタート">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="14" />
                    </svg>
                </div>
                <!-- ファイルエクスプローラーアイコン (タスクバー用) -->
                <div id="file-explorer-clickable-icon-taskbar" class="w-12 h-12 bg-green-600 bg-opacity-70 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-transform duration-200 cursor-pointer" title="ファイルエクスプローラー">
                    <!-- フォルダアイコンのSVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                </div>
            </div>

            <!-- 中央のアイテム (スマートフォン用ホームボタンなど) -->
            <div id="center-taskbar-items" class="flex items-center justify-center">
                <!-- ここにホームボタンが動的に追加されます -->
            </div>

            <!-- 時計と日付 -->
            <div class="text-white text-sm text-right space-y-1">
                <div id="clock" class="font-bold text-lg"></div>
                <div id="date"></div>
            </div>
        </div>
    </div>

    <!-- スタートメニュー -->
    <div id="start-menu" class="fixed w-1/2 bg-gray-800 bg-opacity-95 backdrop-blur-50-percent rounded-r-2xl shadow-2xl z-60 p-6 text-white flex flex-col">
        <h2 class="text-3xl font-bold mb-6">スタートメニュー</h2>
        <div class="space-y-4">
            <button id="start-menu-file-explorer-button" class="w-full text-left px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200">
                ファイルエクスプローラー
            </button>
            <button class="w-full text-left px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200">
                設定
            </button>
            <button class="w-full text-left px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200">
                ドキュメント
            </button>
            <button class="w-full text-left px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200">
                シャットダウン
            </button>
        </div>
        <div class="mt-auto pt-6 border-t border-gray-700">
            <p class="text-gray-400">Nerus OS Lite Ver. 0.2β</p>
        </div>
    </div>

    <script>
        // アプリケーションデータを一時的に保存するグローバルオブジェクト
        const appDataStorage = {};

        // 予測変換の対象となるNerus OS内部URL
        const nerusInternalUrls = [
            'nerus://homepage',
            'nerus://about',
            'nerus://omgshop', // omg shopを追加
            'omgshop.com', // omgshop.comも予測変換の対象に
            'newtube.com', // NewTube.comも予測変換の対象に
            'newtube' // newtubeも予測変換の対象に
        ];

        // 時計と日付を更新する関数
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // 月は0から始まるため+1
            const day = String(now.getDate()).padStart(2, '0');

            document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;
            document.getElementById('date').textContent = `${year}/${month}/${day}`;
        }

        // 1秒ごとに時計を更新
        setInterval(updateClock, 1000);
        // ページロード時に一度更新
        updateClock();

        /**
         * デバイスタイプを検出する関数
         * @returns {string} 'smartphone' または 'desktop'
         */
        function detectDeviceType() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            // よくあるスマートフォンデバイスのUser Agentキーワードをチェック
            // Android, iPhone, iPod をスマートフォンと判定
            if (/android/i.test(userAgent) || /iphone|ipod/i.test(userAgent)) {
                return 'smartphone';
            } else {
                // その他の場合はPC（タブレット含む）と判定
                return 'desktop';
            }
        }

        /**
         * ホームボタンを作成して返す関数
         * @returns {HTMLElement} 作成されたホームボタン要素
         */
        function createHomeButton() {
            const homeButton = document.createElement('button');
            homeButton.id = 'home-button';
            homeButton.className = 'w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl shadow-md hover:scale-105 transition-transform duration-200 cursor-pointer';
            homeButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1V10" />
                </svg>
            `;
            homeButton.title = "ホーム";
            homeButton.addEventListener('click', () => {
                // 現在開いているすべてのアプリケーションウィンドウを閉じる
                const appWindows = document.querySelectorAll('[id$="-window"]'); // IDが'-window'で終わる要素をすべて取得
                appWindows.forEach(windowElement => {
                    closeAppWindowAnimation(windowElement);
                });
            });
            return homeButton;
        }

        // ページロード時にデバイスタイプを検出してホームボタンを追加
        document.addEventListener('DOMContentLoaded', () => {
            const deviceType = detectDeviceType();
            if (deviceType === 'smartphone') {
                const centerTaskbarItems = document.getElementById('center-taskbar-items');
                if (centerTaskbarItems) {
                    centerTaskbarItems.appendChild(createHomeButton());
                }
            }
        });

        // ===========================================
        // Nerus Paint Tool のコンテンツとロジック
        // ===========================================

        // ペイントツールのHTMLコンテンツ
        const paintToolContent = `
            <div class="flex flex-col items-center p-4 w-full h-full"> <!-- p-4 は contentArea のパディングと合わせて調整 -->
                <h1 class="text-3xl font-bold text-white mb-6">Nerus ペイントツール</h1>

                <div class="flex flex-col md:flex-row items-center md:items-start w-full space-y-4 md:space-y-0 md:space-x-6 flex-grow">
                    <!-- ツールバー -->
                    <div class="flex flex-col p-4 bg-gray-700 rounded-2xl shadow-lg md:w-1/4 w-full space-y-4">
                        <h2 class="text-xl font-semibold text-white mb-2">ツール</h2>

                        <!-- 色選択 -->
                        <div>
                            <label for="colorPicker" class="block text-gray-300 text-sm font-medium mb-2">ブラシの色:</label>
                            <!-- カラーピッカーを追加 -->
                            <input type="color" id="colorPicker" value="#000000" class="w-full h-10 rounded-lg shadow-md hover:scale-105 transition-transform duration-200 cursor-pointer mb-2">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <!-- 消しゴムボタンにテキストを追加 -->
                                <button class="color-button w-full h-10 rounded-lg shadow-md hover:scale-105 transition-transform duration-200 flex items-center justify-center text-sm font-bold text-gray-800" style="background-color: #FFFFFF; border: 2px solid #ccc;" data-color="#FFFFFF" title="消しゴム">消しゴム</button>
                            </div>
                        </div>

                        <!-- ブラシサイズ -->
                        <div>
                            <label for="brushSize" class="block text-gray-300 text-sm font-medium mb-2">ブラシサイズ:</label>
                            <input type="range" id="brushSize" min="1" max="50" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <span id="brushSizeValue" class="text-gray-400 text-sm mt-1 block text-center">5</span>
                        </div>

                        <!-- クリアボタン -->
                        <button id="clearButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-md transition-colors duration-200">
                            クリア
                        </button>
                    </div>

                    <!-- キャンバスコンテナ -->
                    <div class="relative flex-grow bg-white rounded-2xl shadow-xl overflow-hidden aspect-video w-full md:w-3/4"> <!-- bg-white を追加 -->
                        <canvas id="paintCanvas" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        `;

        /**
         * 指定されたウィンドウ要素内でペイントツールのロジックを初期化する関数
         * @param {HTMLElement} paintWindowElement - ペイントツールが描画される親のウィンドウ要素（contentAreaなど）
         */
        function initializePaintTool(paintWindowElement) {
            const canvas = paintWindowElement.querySelector('#paintCanvas');
            const ctx = canvas.getContext('2d');

            // デフォルトの描画設定
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let brushColor = '#000000'; // デフォルトは黒
            let brushSize = 5;

            // キャンバスのサイズを親要素に合わせる
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                // 解像度に合わせて描画がぼやけないように調整
                ctx.scale(1, 1); // ここは通常、DPIスケール調整用だが、今回は1で固定
                // 描画スタイルを再設定 (リサイズでリセットされるため)
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = brushSize;
                ctx.strokeStyle = brushColor;
            }

            // 初期描画設定とキャンバスサイズ調整
            ctx.lineCap = 'round'; // 線の端を丸くする
            ctx.lineJoin = 'round'; // 線と線の結合部を丸くする
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = brushColor;
            resizeCanvas(); // 初期表示時にキャンバスサイズを調整

            /**
             * 描画を開始するイベントハンドラ
             * @param {MouseEvent|TouchEvent} e - イベントオブジェクト
             */
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = getCoordinates(e);
            }

            /**
             * 描画中に線を描くイベントハンドラ
             * @param {MouseEvent|TouchEvent} e - イベントオブジェクト
             */
            function draw(e) {
                if (!isDrawing) return;

                e.preventDefault(); // タッチ操作でのスクロールを防止

                const [currentX, currentY] = getCoordinates(e);

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                [lastX, lastY] = [currentX, currentY];
            }

            /**
             * 描画を終了するイベントハンドラ
             */
            function stopDrawing() {
                isDrawing = false;
            }

            /**
             * マウス/タッチイベントから座標を取得するヘルパー関数
             * @param {MouseEvent|TouchEvent} e - イベントオブジェクト
             * @returns {[number, number]} [x, y] 座標
             */
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;

                if (e.touches) { // タッチイベントの場合
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else { // マウスイベントの場合
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                return [
                    (clientX - rect.left) * (canvas.width / rect.width),
                    (clientY - rect.top) * (canvas.height / rect.height)
                ];
            }

            // イベントリスナーの追加 (マウスとタッチの両方に対応)
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing); // キャンバス外に出たとき

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);

            // ブラシサイズスライダー
            const brushSizeSlider = paintWindowElement.querySelector('#brushSize');
            const brushSizeValueDisplay = paintWindowElement.querySelector('#brushSizeValue');
            brushSizeSlider.addEventListener('input', (e) => {
                brushSize = e.target.value;
                ctx.lineWidth = brushSize;
                brushSizeValueDisplay.textContent = brushSize;
            });

            // カラーピッカーのイベントリスナー
            const colorPicker = paintWindowElement.querySelector('#colorPicker');
            colorPicker.addEventListener('input', (e) => {
                brushColor = e.target.value;
                ctx.strokeStyle = brushColor;
            });

            // 消しゴムボタン (白)
            const eraserButton = paintWindowElement.querySelector('.color-button[data-color="#FFFFFF"]');
            if (eraserButton) {
                eraserButton.addEventListener('click', () => {
                    brushColor = eraserButton.dataset.color; // 白に設定
                    ctx.strokeStyle = brushColor;
                    colorPicker.value = brushColor; // カラーピッカーも白に更新
                });
            }
            
            // クリアボタン
            const clearButton = paintWindowElement.querySelector('#clearButton');
            clearButton.addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
        }


        /**
         * アプリケーションウィンドウの生成とアニメーションを管理する汎用関数
         * @param {string} appId - アプリケーションの一意のID (例: 'nerus-browser', 'omg-note', 'file-explorer', 'nerus-calculator', 'nerus-paint-tool')
         * @param {string} title - ウィンドウのタイトル
         * @param {string} initialContentHTML - アプリケーションの初期コンテンツ (HTML文字列)
         * @param {boolean} [isNoteApp=false] - メモ帳アプリの場合true。特別な要素（textarea）を挿入します。
         * @param {HTMLElement|null} [launcherElement=null] - アプリを起動したHTML要素。クリックイベントの停止に使用。
         * @param {HTMLElement|null} [parentWindow=null] - アプリを起動した親ウィンドウ。アプリ起動時に閉じるため。
         */
        function openAppWindow(appId, title, initialContentHTML, isNoteApp = false, launcherElement = null, parentWindow = null) {
            // 既にウィンドウが開いている場合は何もしない
            if (document.getElementById(`${appId}-window`)) {
                return;
            }

            // 親ウィンドウが指定されていれば閉じる
            if (parentWindow) {
                closeAppWindowAnimation(parentWindow);
            }

            // ウィンドウのコンテナ (オーバーレイ)
            const appWindow = document.createElement('div');
            appWindow.id = `${appId}-window`;
            // ウィンドウをデスクトップ領域に配置する (タスクバーは避ける)
            appWindow.className = 'fixed inset-x-0 top-0 bottom-[68px] flex justify-center z-50'; /* z-50はタスクバーより下 */

            // 内部のウィンドウ要素
            const innerWindow = document.createElement('div');
            // 初期状態は小さく透明に設定
            innerWindow.style.opacity = '0';
            
            // Apply common classes
            let innerWindowClasses = 'absolute bg-gray-800 bg-opacity-95 rounded-2xl shadow-2xl flex flex-col transition-all duration-500 ease-out';
            
            // Set position, size, and initial transform based on appId
            if (appId === 'nerus-calculator' || appId === 'nerus-paint-tool') {
                innerWindowClasses += ' max-w-sm h-[calc(100vh-100px)]'; // Smaller, fixed height
                innerWindow.style.top = '15px';
                innerWindow.style.left = '50%'; // Center horizontally
                innerWindow.style.transform = 'scale(0.1) translateX(-50%)'; // Initial transform for centered apps
            } else {
                // Default for browser, note, file explorer
                innerWindow.style.top = '15px';
                innerWindow.style.left = '15px';
                innerWindow.style.right = '15px';
                innerWindow.style.bottom = '15px';
                innerWindowClasses += ' w-[calc(100%-30px)] h-[calc(100%-30px)] max-w-7xl';
                innerWindow.style.transform = 'scale(0.1)'; // Initial transform for other apps (from top-left)
            }
            innerWindow.className = innerWindowClasses;


            // タイトルバー
            const titleBar = document.createElement('div');
            titleBar.className = 'flex justify-between items-center bg-gray-700 px-4 py-2 rounded-t-2xl text-white text-lg font-semibold';
            titleBar.textContent = title;

            // 閉じるボタン
            const closeButton = document.createElement('button');
            closeButton.className = 'w-6 h-6 bg-red-500 rounded-md flex items-center justify-center text-white hover:bg-red-600 transition-colors duration-200';
            closeButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            `;

            // コンテンツエリア
            const contentArea = document.createElement('div');
            // flex-grow で残りのスペースを占め、overflow-y-auto で内部スクロール
            // ここにパディングを追加してテキストエリアの余白を制御
            contentArea.className = 'flex-grow text-white overflow-y-auto flex flex-col p-4'; /* p-4 を追加 */
            let textarea = null; // omg note用のtextareaを保持

            if (isNoteApp) {
                textarea = document.createElement('textarea');
                // テキストエリアの幅と高さを調整 (ウィンドウからの余白15px)
                // contentArea に p-4 (16px) を持たせたので、textarea 自体からはパディングを削除
                textarea.className = 'w-full h-full bg-gray-700 rounded-lg text-white resize-none focus:outline-none focus:ring-2 focus:ring-blue-500'; 
                textarea.placeholder = 'ここに文章を入力してください...';
                // 保存された内容があればロードする
                if (appDataStorage[appId]) {
                    textarea.value = appDataStorage[appId];
                }
                contentArea.appendChild(textarea);
            } else if (appId === 'nerus-browser') {
                // ブラウザ履歴を管理するスタック
                const browserHistory = [];
                let currentHistoryIndex = -1;

                // URLバーコンテナ
                const urlBarContainer = document.createElement('div');
                urlBarContainer.className = 'relative flex p-2 bg-gray-700 rounded-2xl mb-2 items-center space-x-2'; // relativeを追加して予測変換リストの基準にする

                const backButton = document.createElement('button');
                backButton.id = 'browser-back-button';
                backButton.className = 'bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed';
                backButton.textContent = '戻る';
                backButton.disabled = true; // 最初は無効

                const urlInput = document.createElement('input');
                urlInput.id = 'browser-url-input'; // IDを追加
                urlInput.type = 'text';
                urlInput.placeholder = 'URLを入力してください (例: nerus://homepage)';
                urlInput.className = 'flex-grow bg-gray-600 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500';
                urlInput.value = 'nerus://homepage'; // 初期表示URL

                const goButton = document.createElement('button');
                goButton.id = 'browser-go-button'; // IDを追加
                goButton.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200';
                goButton.textContent = 'Go';

                const autocompleteList = document.createElement('div');
                autocompleteList.className = 'autocomplete-list hidden'; // 最初は非表示

                urlBarContainer.appendChild(backButton);
                urlBarContainer.appendChild(urlInput);
                urlBarContainer.appendChild(goButton);
                urlBarContainer.appendChild(autocompleteList); // 予測変換リストをURLバーコンテナに追加

                // ブラウザコンテンツ表示領域
                const browserContentDisplay = document.createElement('div');
                browserContentDisplay.id = 'browser-content-display'; // IDを追加
                browserContentDisplay.className = 'flex-grow bg-gray-900 bg-opacity-70 p-4 rounded-lg overflow-auto';
                browserContentDisplay.innerHTML = initialContentHTML; // 初期コンテンツを設定

                /**
                 * 指定されたURLに移動し、履歴を更新する関数
                 * @param {string} url - 移動先のURL
                 * @param {boolean} pushToHistory - 履歴にプッシュするかどうか (戻るボタンからの遷移の場合はfalse)
                 */
                const navigateToUrl = (url, pushToHistory = true) => {
                    let contentToShow = '';
                    const cleanUrl = url.toLowerCase().trim(); // 入力値を小文字化してトリム
                    let targetUrl = cleanUrl; // 実際に遷移するURLを保持
                    let handledBySpecialCase = false; // Newtubeのコンテンツが直接レンダリングされたかを示すフラグ

                    // 内部URLのキーワードによる直接遷移を優先
                    if (cleanUrl === 'home' || cleanUrl === 'homepage') {
                        targetUrl = 'nerus://homepage';
                    } else if (cleanUrl === 'about') {
                        targetUrl = 'nerus://about';
                    } else if (cleanUrl === 'omgshop') {
                        targetUrl = 'nerus://omgshop'; // 内部URL形式に統一
                    } else if (cleanUrl === 'newtube') {
                        targetUrl = 'nerus://newtube'; // 内部URL形式に統一
                    }

                    if (targetUrl === 'nerus://homepage') {
                        contentToShow = `
                            <h2 class="text-2xl font-bold mb-4">Nerus ホームページ</h2>
                            <p>ここはNerus Browserのホーム画面です。</p>
                            <p class="mt-2 text-gray-400">
                                「<span class="font-bold text-blue-300">nerus://about</span>」と入力してNerus OSについて学ぶことができます。
                            </p>
                            <p class="mt-2 text-gray-400">
                                「<span class="font-bold text-blue-300">nerus://omgshop</span>」でomg shopにアクセスできます。
                            </p>
                        `;
                        urlInput.value = targetUrl; // URLバーを更新
                    } else if (targetUrl === 'nerus://about') {
                        // ここでNerus OS Liteと0.2βを反映
                        contentToShow = `
                            <h2 class="text-2xl font-bold mb-4">Nerus OS Liteについて</h2>
                            <p>Nerus OS Liteは、のらうきとGeminiの共同作業によって開発された実験的なOSインターフェースです。</p>
                            <p class="mt-2 text-gray-400">
                                主にはHTML、CSS (Tailwind CSS)、JavaScriptで構成されており、ブラウザ内で動作します。<br>
                                未来のインターフェースの可能性を探るために作られました。
                            </p>
                            <p class="mt-4 text-sm text-gray-500">バージョン: 0.2β</p>
                        `;
                        urlInput.value = targetUrl; // URLバーを更新
                    } else if (targetUrl === 'nerus://omgshop' || cleanUrl === 'omgshop.com') { // 互換性のためomgshop.comも残す
                        urlInput.value = 'omgshop.com'; // URLバーをomgshop.comに設定
                        contentToShow = `
                            <h2 class="text-2xl font-bold mb-4">omg shopへようこそ！</h2>
                            <p>ここでは、あなたの生活を豊かにする素晴らしい商品を見つけることができます。</p>
                            <p class="mt-4">現在、特別セール実施中！</p>
                            <div class="mt-6 p-4 bg-gray-700 rounded-lg shadow-md">
                                <p class="text-xl font-semibold text-green-400">商品例: 不思議な石</p>
                                <p class="text-gray-300 mt-2">購入できません。</p>
                                <p class="text-right text-lg font-bold mt-4">価格: 1,000,000 NeruCoin</p>
                            </div>
                            <p class="mt-4 text-gray-400">（これはNerus Browser内のシミュレーションです）</p>
                        `;
                    } else if (targetUrl === 'nerus://newtube' || cleanUrl === 'newtube.com') { // 互換性のためnewtube.comも残す
                        urlInput.value = 'newtube.com'; // URLバーをnewtube.comに設定
                        renderNewTubeContent(browserContentDisplay, urlInput); // NewTubeコンテンツを直接レンダリング
                        handledBySpecialCase = true; // Newtubeのコンテンツはここで処理された
                    }
                    else {
                        // その他は通常のNerusearch
                        const encodedQuery = encodeURIComponent(url); // 元のurl (ユーザー入力) をエンコード
                        const searchUrl = `https://nerusearch.com/search?q=${encodedQuery}`;
                        urlInput.value = searchUrl;

                        contentToShow = `
                            <h2 class="text-2xl font-bold mb-4">Nerusearch.com で検索</h2>
                            <p class="text-gray-300">検索クエリ: <span class="font-bold">${url}</span></p>
                            <div class="mt-6 p-4 bg-gray-700 rounded-lg shadow-md">
                                <p class="text-sm text-yellow-400 mb-2">広告</p>
                                <a href="#" onclick="document.getElementById('browser-url-input').value='omgshop.com'; document.getElementById('browser-go-button').click(); return false;" class="text-blue-400 hover:underline text-lg">omgshop.com でお買い物！</a>
                            </div>
                        `;
                    }

                    // specialCaseで処理されていない場合のみinnerHTMLを更新
                    if (!handledBySpecialCase) {
                        browserContentDisplay.innerHTML = contentToShow;
                    }

                    // NewTube検索結果からNewTubeサイトへ遷移するイベントリスナーを設定 (この部分は既存ロジックなので変更なし)
                    // (ただし、このブロックはnavigateToUrlが直接newtube.comを扱った場合は不要になる可能性が高いが、念のため残す)
                    if (handledBySpecialCase && browserContentDisplay.querySelector('[data-destination="newtube"]')) {
                        const newtubeLink = browserContentDisplay.querySelector('[data-destination="newtube"]');
                        if (newtubeLink) {
                            newtubeLink.addEventListener('click', (event) => {
                                event.preventDefault(); // デフォルトのリンク動作を防止
                                renderNewTubeContent(browserContentDisplay, urlInput); // NewTubeコンテンツを直接レンダリング
                                // 履歴には追加しない（既にnavigateToUrlが履歴にあるため）
                            });
                        }
                    }


                    // 履歴の更新
                    if (pushToHistory) {
                        // 現在の履歴インデックスより後ろの履歴は削除
                        browserHistory.splice(currentHistoryIndex + 1);
                        browserHistory.push(targetUrl); // 実際に遷移したURLを履歴に記録
                        currentHistoryIndex = browserHistory.length - 1;
                    }
                    updateNavigationButtons(); // ボタンの状態を更新
                };

                // NewTubeコンテンツを直接レンダリングするヘルパー関数
                function renderNewTubeContent(targetDisplayElement, urlInputToUpdate) {
                    urlInputToUpdate.value = 'newtube.com'; // URLバーをnewtube.comに設定

                    const newTubeHTML = `
                        <h2 class="text-2xl font-bold mb-4">NewTube.com</h2>
                        <p class="text-gray-400 mb-6">人気の動画をチェック！</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-gray-700 rounded-lg shadow-md overflow-hidden">
                                <img src="https://placehold.co/320x180/FF5733/FFFFFF?text=Cute+Cats" alt="Video Thumbnail" class="w-full h-auto object-cover">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-white mb-1">猫の可愛いいたずら集</h3>
                                    <p class="text-sm text-gray-400">チャンネル名: CuteAnimals / 視聴回数: 1.2M</p>
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg shadow-md overflow-hidden">
                                <img src="https://placehold.co/320x180/33FF57/000000?text=Coding+Tutorial" alt="Video Thumbnail" class="w-full h-auto object-cover">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-white mb-1">プログラミング初心者向けチュートリアル</h3>
                                    <p class="text-sm text-gray-400">チャンネル名: CodeMaster / 視聴回数: 500K</p>
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg shadow-md overflow-hidden">
                                <img src="https://placehold.co/320x180/3357FF/FFFFFF?text=World+Travel" alt="Video Thumbnail" class="w-full h-auto object-cover">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-white mb-1">世界の絶景4Kタイムラプス</h3>
                                    <p class="text-sm text-gray-400">チャンネル名: TravelVlog / 視聴回数: 2.5M</p>
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg shadow-md overflow-hidden">
                                <img src="https://placehold.co/320x180/FF33DA/000000?text=Cooking+Basics" alt="Video Thumbnail" class="w-full h-auto object-cover">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-white mb-1">料理の基本：美味しいパスタの作り方</h3>
                                    <p class="text-sm text-gray-400">チャンネル名: CookingAtHome / 視聴回数: 800K</p>
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg shadow-md overflow-hidden">
                                <img src="https://placehold.co/320x180/33DAFF/FFFFFF?text=Gadget+Review" alt="Video Thumbnail" class="w-full h-auto object-cover">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-white mb-1">最新ガジェットレビュー2025</h3>
                                    <p class="text-sm text-gray-400">チャンネル名: TechGuru / 視聴回数: 1.8M</p>
                                </div>
                            </div>
                        </div>
                    `;
                    targetDisplayElement.innerHTML = newTubeHTML;
                    // この遷移はNerusearchの結果からのクリックなので、履歴には追加しない
                }

                // ナビゲーションボタンの状態を更新する関数
                const updateNavigationButtons = () => {
                    backButton.disabled = currentHistoryIndex <= 0; // 最初のページまたは履歴がない場合は戻るボタンを無効化
                };

                // URL入力時のイベントリスナー (予測変換)
                urlInput.addEventListener('input', () => {
                    const inputValue = urlInput.value.toLowerCase().trim(); // 空白文字をトリム
                    autocompleteList.innerHTML = ''; // リストをクリア
                    autocompleteList.classList.add('hidden'); // まず非表示にする

                    let urlsToShow = [];
                    if (inputValue.length === 0) {
                        // 入力が空の場合、すべての内部URLを表示
                        urlsToShow = nerusInternalUrls;
                    } else {
                        // 入力がある場合、入力に基づいてフィルタリング
                        urlsToShow = nerusInternalUrls.filter(url => url.includes(inputValue));
                    }

                    if (urlsToShow.length > 0) {
                        urlsToShow.forEach(itemUrl => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.textContent = itemUrl;
                            item.onclick = () => {
                                urlInput.value = itemUrl;
                                autocompleteList.classList.add('hidden'); // 選択したら非表示
                                navigateToUrl(itemUrl); // navigateToUrlを呼び出す
                            };
                            autocompleteList.appendChild(item);
                        });
                        autocompleteList.classList.remove('hidden'); // 候補があれば表示
                    }
                });

                // URLバー以外をクリックしたら予測変換リストを非表示にする
                document.addEventListener('click', (event) => {
                    if (!urlBarContainer.contains(event.target)) {
                        autocompleteList.classList.add('hidden');
                    }
                });

                // Goボタンのイベントリスナー
                goButton.onclick = () => {
                    navigateToUrl(urlInput.value.trim());
                    autocompleteList.classList.add('hidden'); // Goボタンを押したら非表示
                };

                // 戻るボタンのイベントリスナー
                backButton.onclick = () => {
                    if (currentHistoryIndex > 0) {
                        currentHistoryIndex--;
                        const prevUrl = browserHistory[currentHistoryIndex];
                        urlInput.value = prevUrl; // URLバーも更新
                        navigateToUrl(prevUrl, false); // 履歴にプッシュせず移動
                    }
                };

                // contentAreaにURLバーとブラウザコンテンツを追加
                contentArea.appendChild(urlBarContainer);
                contentArea.appendChild(browserContentDisplay);

                // 初期ページの読み込みと履歴への追加
                navigateToUrl('nerus://homepage'); // 最初はホームページを表示
            } else if (appId === 'file-explorer') {
                // ファイルエクスプローラーのコンテンツを直接挿入
                contentArea.innerHTML = initialContentHTML;
                // Note: イベントリスナーの追加は、ウィンドウがDOMに挿入されてから行われます。
            } else if (appId === 'nerus-calculator') {
                // 電卓アプリのコンテンツを直接挿入
                contentArea.classList.remove('p-4'); // 電卓アプリ自体がパディングを持つため
                contentArea.innerHTML = initialContentHTML;
            } else if (appId === 'nerus-paint-tool') {
                // ペイントツールのコンテンツを挿入し、初期化関数を呼び出す
                contentArea.classList.remove('p-4'); // ペイントツール自体がパディングを持つため
                contentArea.classList.add('items-center', 'justify-center'); // ペイントツールを中央に配置
                contentArea.innerHTML = paintToolContent;
            }
            
            // 閉じるボタンのイベントリスナーを設定 (isNoteAppに応じて分岐)
            closeButton.onclick = () => {
                if (isNoteApp) {
                    showSaveConfirmation(appId, appWindow, textarea);
                } else {
                    closeAppWindowAnimation(appWindow); // 関数呼び出しに統一
                }
            };
            

            titleBar.appendChild(closeButton);
            innerWindow.appendChild(titleBar);
            innerWindow.appendChild(contentArea);
            appWindow.appendChild(innerWindow);
            document.body.appendChild(appWindow);

            // DOMに追加後、次のフレームでアニメーションを開始
            requestAnimationFrame(() => {
                innerWindow.style.opacity = '1';
                if (appId === 'nerus-calculator' || appId === 'nerus-paint-tool') {
                    innerWindow.style.transform = 'scale(1) translateX(-50%)'; // 中央寄せアニメーションを維持
                } else {
                    innerWindow.style.transform = 'scale(1)'; // デフォルトのtransform (左上から拡大)
                }
            });

            // --- 重要: 各アプリ固有の初期化 (DOM挿入後に行う) ---
            if (appId === 'file-explorer') {
                const fileListArea = appWindow.querySelector('#file-list-area'); // appWindowからクエリ
                const sidebarToggleBtn = appWindow.querySelector('#sidebar-toggle-btn');
                const sidebar = appWindow.querySelector('#file-explorer-sidebar');


                // サイドバーの項目クリックリスナーをアタッチ
                const sidebarItems = appWindow.querySelectorAll('[data-folder-path]'); // appWindowからクエリ
                sidebarItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const path = item.dataset.folderPath;
                        renderFileExplorerContent(fileListArea, path, appWindow); // コンテンツをレンダリング
                        
                        // サイドバーのアクティブ状態を更新
                        sidebarItems.forEach(sItem => sItem.classList.remove('bg-gray-600'));
                        item.classList.add('bg-gray-600');
                    });
                });

                // サイドバーのトグル機能
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    // トグルボタンのアイコンを変更
                    if (sidebar.classList.contains('collapsed')) {
                        sidebarToggleBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        `; // 右向きの二重矢印
                        sidebarToggleBtn.title = "サイドバーを展開";
                    } else {
                        sidebarToggleBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                            </svg>
                        `; // 左向きの二重矢印
                        sidebarToggleBtn.title = "サイドバーを折りたたむ";
                    }
                });


                // デスクトップの初期レンダリング (デスクトップ項目へのアプリ起動リスナーもアタッチ)
                renderFileExplorerContent(fileListArea, 'desktop', appWindow);
                // デスクトップの初期アクティブ状態を設定
                const desktopSidebarItem = appWindow.querySelector('[data-folder-path="desktop"]');
                if (desktopSidebarItem) {
                    desktopSidebarItem.classList.add('bg-gray-600');
                }
            } else if (appId === 'nerus-calculator') {
                // 電卓アプリのロジックを初期化
                const display = appWindow.querySelector('#calc-display');
                const buttons = appWindow.querySelectorAll('.calc-button');
                let currentInput = '0';
                let firstOperand = null;
                let operator = null;
                let waitingForSecondOperand = false;

                function updateDisplay() {
                    display.value = currentInput;
                }

                function clear() {
                    currentInput = '0';
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                    updateDisplay();
                }

                function inputDigit(digit) {
                    if (waitingForSecondOperand === true) {
                        currentInput = digit;
                        waitingForSecondOperand = false;
                    } else {
                        currentInput = currentInput === '0' ? digit : currentInput + digit;
                    }
                    updateDisplay();
                }

                function inputDecimal(dot) {
                    if (waitingForSecondOperand === true) {
                        currentInput = "0."
                        waitingForSecondOperand = false;
                        return;
                    }
                    if (!currentInput.includes(dot)) {
                        currentInput += dot;
                    }
                    updateDisplay();
                }

                function handleOperator(nextOperator) {
                    const inputValue = parseFloat(currentInput);

                    if (operator && waitingForSecondOperand) {
                        operator = nextOperator;
                        return;
                    }

                    if (firstOperand === null) {
                        firstOperand = inputValue;
                    } else if (operator) {
                        const result = operate(operator, firstOperand, inputValue);
                        currentInput = String(result);
                        firstOperand = result;
                    }

                    waitingForSecondOperand = true;
                    operator = nextOperator;
                    updateDisplay();
                }

                function operate(operator, num1, num2) {
                    if (operator === '+') return num1 + num2;
                    if (operator === '-') return num1 - num2;
                    if (operator === '*') return num1 * num2;
                    if (operator === '/') {
                        if (num2 === 0) return 'Error: Div by 0';
                        return num1 / num2;
                    }
                    return num2; // Default for equals without operator
                }

                buttons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        const { target } = event;
                        if (!target.matches('button')) {
                            return;
                        }

                        if (target.classList.contains('operator')) {
                            handleOperator(target.value);
                            return;
                        }

                        if (target.classList.contains('decimal')) {
                            inputDecimal(target.value);
                            return;
                        }

                        if (target.classList.contains('clear')) {
                            clear();
                            return;
                        }

                        inputDigit(target.value);
                    });
                });

                // Initialize display
                updateDisplay();
            } else if (appId === 'nerus-paint-tool') {
                // ペイントツールの初期化
                initializePaintTool(contentArea);
            }
        }

        /**
         * 保存確認ダイアログを表示する関数
         * @param {string} appId - 閉じようとしているアプリのID
         * @param {HTMLElement} appWindow - 閉じる対象のアプリウィンドウ要素
         * @param {HTMLElement} noteTextareaElement - omg noteのtextarea要素
         */
        function showSaveConfirmation(appId, appWindow, noteTextareaElement) {
            // ダイアログが既に開いている場合は何もしない
            if (document.getElementById('save-confirm-dialog')) {
                return;
            }

            const dialogOverlay = document.createElement('div');
            dialogOverlay.id = 'save-confirm-dialog';
            dialogOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]'; // z-indexを高く設定

            const dialogBox = document.createElement('div');
            dialogBox.className = 'bg-gray-800 p-6 rounded-2xl shadow-xl text-white text-center flex flex-col items-center space-y-4 max-w-sm w-11/12';

            const message = document.createElement('p');
            message.className = 'text-lg font-semibold';
            message.textContent = '変更を保存しますか？';

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-center space-x-2 w-full';

            const saveButton = document.createElement('button');
            saveButton.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-xl transition-colors duration-200 flex-1 text-xs';
            saveButton.textContent = '保存';
            saveButton.onclick = () => {
                appDataStorage[appId] = noteTextareaElement.value; // 内容をグローバルストレージに保存
                console.log('ノートが疑似的に保存されました。');
                dialogOverlay.remove();
                closeAppWindowAnimation(appWindow);
            };

            const discardButton = document.createElement('button');
            discardButton.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-xl transition-colors duration-200 flex-1 text-xs';
            discardButton.textContent = '保存しない';
            discardButton.onclick = () => {
                appDataStorage[appId] = ''; 
                console.log('ノートは保存されませんでした。内容がクリアされました。');
                dialogOverlay.remove();
                closeAppWindowAnimation(appWindow);
            };

            const cancelButton = document.createElement('button');
            cancelButton.className = 'bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-xl transition-colors duration-200 flex-1 text-xs';
            cancelButton.textContent = 'キャンセル';
            cancelButton.onclick = () => {
                dialogOverlay.remove();
            };

            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(discardButton);
            buttonContainer.appendChild(cancelButton);

            dialogBox.appendChild(message);
            dialogBox.appendChild(buttonContainer);
            dialogOverlay.appendChild(dialogBox);
            document.body.appendChild(dialogOverlay);
        }

        /**
         * アプリケーションウィンドウをアニメーション付きで閉じる汎用関数
         * @param {HTMLElement} appWindow - 閉じる対象のアプリウィンドウ要素
         */
        function closeAppWindowAnimation(appWindow) {
            const innerWindow = appWindow.querySelector('div'); // appWindowの子要素を取得

            innerWindow.style.opacity = '0';
            // Set transform based on appId to ensure correct shrinking
            if (appWindow.id === 'nerus-calculator-window' || appWindow.id === 'nerus-paint-tool-window') {
                innerWindow.style.transform = 'scale(0.1) translateX(-50%)'; // Shrink to center
            } else {
                innerWindow.style.transform = 'scale(0.1)'; // Shrink to top-left
            }
            
            setTimeout(() => {
                appWindow.remove();
            }, 500); // CSSのduration-500に合わせる
        }

        /**
         * ファイルエクスプローラーのコンテンツをレンダリングする関数
         * @param {HTMLElement} targetElement - ファイルリストを表示するDOM要素
         * @param {string} path - 表示するパス ('desktop', 'downloads', 'documents', 'c_drive')
         * @param {HTMLElement} currentFileExplorerWindow - 現在のファイルエクスプローラーのウィンドウ要素
         */
        function renderFileExplorerContent(targetElement, path, currentFileExplorerWindow) {
            let contentHtml = '';
            let currentPathName = '';

            switch (path) {
                case 'desktop':
                    currentPathName = 'デスクトップ';
                    contentHtml = `
                        <div class="grid grid-cols-1 gap-1">
                            <!-- Nerus Browser.nrs -->
                            <div class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer" data-app-launch-id="nerus-browser-app">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span class="text-white">Nerus Browser.nrs</span>
                            </div>
                            <!-- omg note.nrs -->
                            <div class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer" data-app-launch-id="omg-note-app">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                <span class="text-white">omg note.nrs</span>
                            </div>
                            <!-- Nerus Calculator.nrs -->
                            <div class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer" data-app-launch-id="nerus-calculator-app">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m-3 4v6m-2-2h4m2 0H7m12-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2z" />
                                </svg>
                                <span class="text-white">Nerus Calculator.nrs</span>
                            </div>
                             <!-- Nerus Paint.nrs -->
                            <div class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer" data-app-launch-id="nerus-paint-tool-app">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343V4.766a2 2 0 012.535-1.921l2.766.766a2 2 0 011.921 2.535V16.5M18 9l-4 4" />
                                </svg>
                                <span class="text-white">Nerus Paint.nrs</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'downloads':
                    currentPathName = 'ダウンロード';
                    contentHtml = `
                        <p class="text-gray-400">このフォルダーは空です。</p>
                    `;
                    break;
                case 'documents':
                    currentPathName = 'ドキュメント';
                    contentHtml = `
                        <p class="text-gray-400">このフォルダーは空です。</p>
                    `;
                    break;
                case 'c_drive':
                    currentPathName = 'ローカルディスク (C:)';
                    contentHtml = `
                        <p class="text-gray-400">このドライブは現在、システムファイルとアプリケーションデータで満たされています。</p>
                        <p class="text-sm text-gray-500 mt-2">空き容量: 116GB / 総容量: 128GB</p>
                    `;
                    break;
                default:
                    currentPathName = '不明なパス';
                    contentHtml = `<p class="text-red-400">指定されたパスは見つかりませんでした。</p>`;
            }

            targetElement.innerHTML = `
                <h3 class="text-lg font-semibold mb-3 text-gray-200">${currentPathName}</h3>
                ${contentHtml}
            `;

            // アプリ起動イベントリスナーを再設定 (file-list-area内で動的に生成された要素にアタッチ)
            const fileItems = targetElement.querySelectorAll('[data-app-launch-id]');
            fileItems.forEach(item => {
                item.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const appToLaunch = item.dataset.appLaunchId;
                    if (appToLaunch === 'nerus-browser-app') {
                        openAppWindow('nerus-browser', 'Nerus Browser', `
                            <h2 class="text-2xl font-bold mb-4">Nerus ホームページ</h2>
                            <p>ここはNerus Browserのホーム画面です。</p>
                            <p class="mt-2 text-gray-400">
                                「<span class="font-bold text-blue-300">nerus://about</span>」と入力してNerus OSについて学ぶことができます。
                            </p>
                            <p class="mt-2 text-gray-400">
                                「<span class="font-bold text-blue-300">nerus://omgshop</span>」でomg shopにアクセスできます。
                            </p>
                        `, false, item, currentFileExplorerWindow);
                    } else if (appToLaunch === 'omg-note-app') {
                        openAppWindow('omg-note', 'omg note', '', true, item, currentFileExplorerWindow);
                    } else if (appToLaunch === 'nerus-calculator-app') {
                        openAppWindow('nerus-calculator', 'Nerus Calculator', calculatorAppContent, false, item, currentFileExplorerWindow);
                    } else if (appToLaunch === 'nerus-paint-tool-app') {
                        openAppWindow('nerus-paint-tool', 'Nerus Paint Tool', paintToolContent, false, item, currentFileExplorerWindow);
                    }
                });
            });
        }

        // Calculator App window content
        const calculatorAppContent = `
            <div class="flex flex-col h-full items-center justify-center p-4">
                <div class="bg-gray-700 rounded-xl shadow-xl w-full max-w-sm overflow-hidden">
                    <!-- Display -->
                    <input type="text" id="calc-display" class="w-full h-20 text-4xl text-right bg-gray-900 text-white px-4 rounded-t-xl outline-none" value="0" readonly>

                    <!-- Buttons Grid -->
                    <div class="grid grid-cols-4 gap-2 p-4">
                        <button class="calc-button bg-gray-600 hover:bg-gray-500 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 clear col-span-2" value="C">C</button>
                        <button class="calc-button bg-gray-600 hover:bg-gray-500 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 operator" value="/">/</button>
                        <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 operator" value="*">*</button>

                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="7">7</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="8">8</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="9">9</button>
                        <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 operator" value="-">-</button>

                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="4">4</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="5">5</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="6">6</button>
                        <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 operator" value="+">+</button>

                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="1">1</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="2">2</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200" value="3">3</button>
                        <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 operator row-span-2" value="=">=</button>

                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 col-span-2" value="0">0</button>
                        <button class="calc-button bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold py-4 rounded-xl transition-colors duration-200 decimal" value=".">.</button>
                    </div>
                </div>
            </div>
        `;


        // Nerus Browser起動
        const nerusBrowserIcon = document.getElementById('nerus-browser-clickable-icon');
        nerusBrowserIcon.addEventListener('click', () => {
            openAppWindow('nerus-browser', 'Nerus Browser', `
                <h2 class="text-2xl font-bold mb-4">Nerus ホームページ</h2>
                <p>ここはNerus Browserのホーム画面です。</p>
                <p class="mt-2 text-gray-400">
                                「<span class="font-bold text-blue-300">nerus://about</span>」と入力してNerus OSについて学ぶことができます。
                            </p>
                            <p class="mt-2 text-gray-400">
                                「<span class="font-bold text-blue-300">nerus://omgshop</span>」でomg shopにアクセスできます。
                            </p>
            `, false);
        });

        // omg note起動
        const omgNoteIcon = document.getElementById('omg-note-clickable-icon');
        omgNoteIcon.addEventListener('click', () => {
            openAppWindow('omg-note', 'omg note', '', true); // trueを渡してメモ帳モードを有効にする
        });

        // Nerus Calculator起動
        const nerusCalculatorIcon = document.getElementById('nerus-calculator-clickable-icon');
        nerusCalculatorIcon.addEventListener('click', () => {
            openAppWindow('nerus-calculator', 'Nerus Calculator', calculatorAppContent, false);
        });

        // Nerus Paint Tool起動
        const nerusPaintToolIcon = document.getElementById('nerus-paint-tool-clickable-icon');
        nerusPaintToolIcon.addEventListener('click', () => {
            openAppWindow('nerus-paint-tool', 'Nerus Paint Tool', paintToolContent, false);
        });

        // File Explorer (タスクバーアイコン) 起動
        const fileExplorerTaskbarIcon = document.getElementById('file-explorer-clickable-icon-taskbar');
        fileExplorerTaskbarIcon.addEventListener('click', () => {
            openAppWindow('file-explorer', 'ファイルエクスプローラー', fileExplorerContent, false); // initialContentHTMLを渡すように修正
        });

        // スタートボタンのイベントリスナー
        const startButton = document.getElementById('start-button');
        const startMenu = document.getElementById('start-menu');

        startButton.addEventListener('click', (event) => {
            event.stopPropagation(); // クリックイベントがbodyに伝播するのを防ぐ
            startMenu.classList.toggle('start-menu-active'); // クラスをトグル
        });

        // スタートメニューのファイルエクスプローラーボタンのイベントリスナー
        const startMenuFileExplorerButton = document.getElementById('start-menu-file-explorer-button');
        startMenuFileExplorerButton.addEventListener('click', () => {
            openAppWindow('file-explorer', 'ファイルエクスプローラー', fileExplorerContent, false); // initialContentHTMLを渡すように修正
            startMenu.classList.remove('start-menu-active'); // メニューを閉じる
        });


        // スタートメニュー以外の場所をクリックで閉じるイベントリスナー
        document.body.addEventListener('click', (event) => {
            // クリックされた要素がスタートメニュー内、またはスタートボタンであるかを確認
            const isClickInsideMenu = startMenu.contains(event.target);
            const isClickOnStartButton = startButton.contains(event.target);

            // スタートメニューが表示中で、かつクリックがメニュー内でもスタートボタンでもない場合
            if (startMenu.classList.contains('start-menu-active') && !isClickInsideMenu && !isClickOnStartButton) {
                startMenu.classList.remove('start-menu-active'); // クラスを削除して非表示にする
            }
        });
    </script>
</body>
</html>
